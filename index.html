<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Bixi Bits - Une journée dans la vie de Bixi</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
            background-color:#eee;
            border: 10px solid #ff674a;
        }
        #branding {
            background-color: #ff674a;
            color: #fff;
            width: 250px;
            padding: 20px 60px 40px 20px;
            position: absolute;
            top: 40px;
            left: 40px;
        }
        #branding h1 {
            font-size: 30px;
            text-transform: uppercase;
            margin-bottom: 0.4em;
            font-weight: 400;
        }
        #branding h2 {
            font-size: 18px;
            font-weight: 400;
        }
        #timer {
            display:none;
            color: #ff674a;
            position:absolute;
            top: 40px;
            right: 40px;
            font-size: 60px;
            line-height: 0.8em;
            text-transform: uppercase;
            font-weight: 400;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 1);
        }
    </style>
<body>
<div id="map"></div>

<div id="branding">
    <h1>Bixi Bits</h1>
    <h2>Une journée dans <br>la vie de Bixi</h2>
</div>

<div id="timer">
    <span id="hours">04</span>:<span id="minutes">00</span>
</div>
<script>
BIXIBEATS = {
    mbToken : 'pk.eyJ1IjoiYnJvY2hlYWZvaW4iLCJhIjoiY2loaWljbjNqMDR5MXRoajd3dmpmYmFrbiJ9.tbocSVZpED7Bu18y3jzB3g',
    mbStyle : 'wells-aud.c3ab9cb0',
    timeScale : 300,
    riderTypes : {
        ff : '#FF674A',
        fe : '#62BDFF',
        mf : '#2017AD',
        me : '#EDC431',
        g : '#DB52B6'
    },
    clock : {
        hours: 4,
        minutes: 0
    },
    opacity: 0.8
};

$(document).ready( function () {
    var gettingStations = $.getJSON( 'data/stations.json', function( stations ) {
        L.mapbox.accessToken = BIXIBEATS.mbToken;
        BIXIBEATS.map = L.mapbox.map( 'map', BIXIBEATS.mbStyle, {zoomControl: false})
                .addControl( L.control.zoom({ position: 'bottomleft' }) )
                .fitBounds( stations , { paddingTopLeft : [ 300, 160 ]})
        ;
    })
    var gettingRoutes = $.getJSON('data/routes.json');
    var gettingRides = $.getJSON('data/rides.json');
    $.when( gettingRoutes, gettingRides, gettingStations )
            .then(
            function( routesXHR, ridesXHR ) {
                var routes = routesXHR[0];
                var rides = ridesXHR[0];
                var tl = new TimelineLite({
                    autoRemoveChildren: false,
                    onStart: function() {
                        $('#timer').show();
                    }
                });

                var nextRide = 0;
                for ( var s = 0; s <  3600 * 24; s += 900 ) {
                    var hourLine = new TimelineLite();
                    var nextHour = s + 900;
                    for ( var i = nextRide; i < rides.length; i++ ) {
                        var ride = rides[i];
                        // In next hour
                        if ( ride.start > nextHour ) {
                            nextRide = i;
                            break;
                        }
                        var route = routes[ride.route-1];
                        var marker = L.circleMarker( route[0].s, {
                            radius : 2.5,
                            stroke : false,
                            clickable : false,
                            fillColor : BIXIBEATS.riderTypes[ride.type],
                            fillOpacity : 0
                        } );
                        var rideLine = new TimelineLite({
                            callbackScope: marker,
                            onStart: function() {
                                this.addTo( BIXIBEATS.map );
                            },
                            onComplete: function() {
                                BIXIBEATS.map.removeLayer( this );
                            }
                        });
                        rideLine.add(TweenLite.to(
                                { opacity: 0 },
                                90,
                                {
                                    opacity: BIXIBEATS.opacity,
                                    callbackScope: marker,
                                    onUpdateParams: [ "{self}"],
                                    onUpdate: function( tweenObj ) {
                                        this.setStyle( { fillOpacity: tweenObj.target.opacity } );
                                    }
                                }
                        ));
                        route.forEach( function( leg ) {
                            rideLine.add(TweenLite.to(
                                    { lat: leg.s[0], lon: leg.s[1] },
                                    ride.duration * leg.p,
                                    {
                                        lat: leg.e[0],
                                        lon: leg.e[1],
                                        ease: Linear.easeNone,
                                        callbackScope: marker,
                                        onUpdateParams: [ "{self}"],
                                        onUpdate: function( tweenObj ) {
                                            this.setLatLng( [ tweenObj.target.lat, tweenObj.target.lon ]);
                                        }
                                    }
                            ))
                        });
                        rideLine.add(TweenLite.to(
                                { opacity: BIXIBEATS.opacity },
                                90,
                                {
                                    opacity: 0,
                                    callbackScope: marker,
                                    onUpdateParams: [ "{self}"],
                                    onUpdate: function( tweenObj ) {
                                        this.setStyle( { fillOpacity: tweenObj.target.opacity } );
                                    }
                                }
                        ));
                        hourLine.add( rideLine, ride.start - s );
                    }
                    tl.add( hourLine, s );
                }

                var timer = TweenMax.to( { minutes: -0.5 }, 3600  , {
                    minutes : 59.49,
                    ease:Linear.easeNone,
                    roundProps: 'minutes' ,
                    callbackScope: $('#timer'),
                    repeat: 23,
                    onUpdate: function( tweenObj ) {
                        this.find('#minutes').text( ('0' + tweenObj.target.minutes).substr(-2,2) );
                    },
                    onUpdateParams: [ "{self}" ],
                    onRepeat: function() {
                        $hour = this.find('#hours');
                        currentHour = parseInt( $hour.text() );
                        if ( currentHour == 23 ) {
                            currentHour = 0;
                        } else {
                            currentHour++;
                        }
                        $hour.text( ('0' + currentHour).substr(-2,2) )
                    }
                });

                tl.add( timer, 0 )
                        .timeScale(BIXIBEATS.timeScale)
                        .play();

            },
            function() {
                console.log('Could not get data');
            }
    );
});
</script>

</body>
</html>